import re
from datetime import datetime
from zoneinfo import ZoneInfo

def _clean_text(text):
    '''Replaces pipes to prevent breaking markdown tables.'''

    if not text:
        return ''

    cleaned_text = re.sub(r'\s+', ' ', text.replace('|', ' - ').strip())
#     cleaned_text = re.sub(r'\n\s*', ', ', cleaned_text) # NOTE: Need to figure how to turn markdown into plain text
#     cleaned_text = re.sub(r'^\n\s*-\s*.*', '; ', cleaned_text)
    return cleaned_text

def _generate_table_rows(columns):
    '''Iterates through columns to build table rows.'''

    rows = []
    if not columns:
        return "| *No columns found* | - | - |"

    for c, column in enumerate(columns):
        col_name = column.get('name', f'Column_{c}')
        col_type = column.get('type', 'string')
        col_desc = column.get('description', '')

        row = f"| **{col_name}** | `{col_type}` | {col_desc} |"
        rows.append(row)

    return '\n'.join(rows)

def dataset_to_markdown(dataset_metadata, dataset_sources=None):
    '''Turns dictionary of dataset metadata into markdown string.'''

    ds_name = dataset_metadata.get('name', 'unnamed dataset')
    ds_type = dataset_metadata.get('type', 'unknown type')
    ds_conn = dataset_metadata.get('connection', 'unknown connection')
    ds_proj = dataset_metadata.get('project_name', 'unknown project name')
    ds_pkey = dataset_metadata.get('project_key', 'unknown project key')
    ds_summary = _clean_text(dataset_metadata.get('short_description', 'No summary available.').replace('#', ''))
    ds_description = _clean_text(dataset_metadata.get('long_description', 'No detailed description provided.').replace('#', ''))

    if not ds_summary:
        ds_summary = 'No summary available.'

    if not ds_description:
        ds_description = 'No detailed description provided.'
        
    if (not dataset_sources) or (not isinstance(dataset_sources, list)):
        ds_sources = 'Not calculated.'
    else:
        ds_sources = ', '.join([f'{d[1]} [{d[0]}]' for d in dataset_sources])

    columns = dataset_metadata.get('columns', [])
    table_rows = _generate_table_rows(columns)

    timestamp = datetime.now(ZoneInfo("America/New_York")).strftime('%Y-%m-%d %H:%M:%S %Z')

    markdown_output = \
f"""
# {ds_name}
**{ds_summary}**

## Overview
{ds_description}
> Connection: **{ds_conn} ({ds_type})**
> Project: **{ds_proj} ({ds_pkey})**
> Sources: **{ds_sources}**

## Data Dictionary
| Column Name | Type | Description |
| :--- | :---: | :--- |
{table_rows}

---
*Auto-generated by **wiki_generator** on {timestamp}*
"""

    return markdown_output